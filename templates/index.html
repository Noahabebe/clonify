<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lip Sync & Speech Verification</title>
  <!-- Tailwind CSS -->
  <link href="https://unpkg.com/tailwindcss@^3/dist/tailwind.min.css" rel="stylesheet" crossorigin="anonymous" />

  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    /* Modal Styles */
    #modalOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #modalContent {
      background: white;
      padding: 1.5rem;
      border-radius: 0.5rem;
      max-width: 600px;
      width: 90%;
    }
    /* Face Guide Overlay */
    #faceGuide {
      position: absolute;
      top: 0;
      left: 0;
      width: 320px;
      height: 240px;
      pointer-events: none;
      background: url('static/face_structure.png') center center no-repeat;
      background-size: contain;
      opacity: 0; /* Initially hidden */
      transition: opacity 0.3s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen relative">
  <!-- Privacy Policy Modal -->
  <div id="modalOverlay">
    <div id="modalContent" class="p-6">
      <h2 class="text-xl font-bold mb-4">Privacy Policy & Terms of Use</h2>
      <p class="mb-4 text-sm">
        By using this website, you consent to have your voice and video recorded for voice cloning and lip-syncing purposes.
        Your data will be used solely for generating a synthetic video matching your voice and will not be shared with third parties.
        Please read our full <a href="#" class="text-blue-500 underline">Privacy Policy</a> and <a href="#" class="text-blue-500 underline">Terms of Use</a>.
      </p>
      <div class="flex justify-end space-x-4">
        <button id="declineBtn" class="bg-red-500 text-white px-4 py-2 rounded">Decline</button>
        <button id="acceptBtn" class="bg-green-500 text-white px-4 py-2 rounded">Accept & Continue</button>
      </div>
    </div>
  </div>
  
  <!-- Main Content (hidden until user accepts) -->
  <div id="mainContent" class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full hidden">
    <h1 class="text-2xl font-bold text-center mb-6">Lip Sync & Speech Verification</h1>
    
    <!-- Instructions -->
    <div class="mb-4 p-4 border rounded bg-gray-50">
      <p class="mb-2 font-semibold">Instructions:</p>
      <ul class="list-disc list-inside text-sm">
        <li>Record a video of <span class="font-bold">up to 30 seconds</span>.</li>
        <li>Align your face within the onâ€‘screen guide below.</li>
        <li>Recite the following tongue twister for best voice cloning and phoneme coverage:</li>
        <li class="italic">
          "She sells seashells by the seashore; Peter Piper picked a peck of pickled peppers; How can a clam cram in a clean cream can?"
        </li>
      </ul>
    </div>
    
    <!-- Recording and Submission Form -->
    <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
      <!-- Video Recording Controls -->
      <div class="mb-4">
        <div class="flex justify-center space-x-4">
          <button type="button" id="startRecording" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition duration-200">Start Recording</button>
          <button type="button" id="stopRecording" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition duration-200 hidden">Stop Recording</button>
        </div>
        <p class="text-center text-sm mt-2">Record a video (max 30 seconds).</p>
      </div>
      
      <!-- Custom Script -->
      <div class="mb-4">
        <label for="script" class="block text-gray-700 font-medium">Custom Script (include the tongue twister):</label>
        <textarea name="script" id="script" rows="4" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="E.g., She sells seashells by the seashore; Peter Piper picked a peck of pickled peppers; How can a clam cram in a clean cream can?"></textarea>
      </div>
      <div class="mb-4">
        <label for="toggle_face_movement" class="inline-flex items-center">
          <input type="checkbox" name="toggle_face_movement" id="toggle_face_movement" class="form-checkbox">
          <span class="ml-2">Enable face movement effect</span>
        </label>
      </div>
      <button type="submit" class="w-full bg-blue-500 text-white font-bold py-2 rounded hover:bg-blue-600 transition duration-200">Process Video</button>
    </form>
    
    <!-- Progress Indicator -->
    <div id="progress" class="hidden mt-4 text-center text-gray-600">
      <span class="loader animate-spin border-4 border-blue-500 border-t-transparent rounded-full w-6 h-6 inline-block"></span>
      Processing your video...
    </div>
    
    <!-- Message -->
    <div id="message" class="hidden mt-4 text-center text-white p-2 rounded"></div>
    
    <!-- Download Button -->
    <div id="downloadContainer" class="hidden mt-4 text-center">
      <a id="downloadLink" class="bg-green-500 text-white font-bold py-2 px-4 rounded hover:bg-green-600 transition duration-200">Download Processed Video</a>
    </div>
    
    <!-- Face Tracking & Recording Section -->
    <div class="mt-6 relative">
      <p class="text-center mb-2 text-sm font-semibold">Align your face within the guide below:</p>
      <video id="trackingVideo" width="320" height="240" autoplay class="rounded border"></video>
      <!-- Face structure overlay -->
      <div id="faceGuide"></div>
    </div>
  </div>
  
  <!-- Scripts -->
  <!-- Load face-api.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js/dist/face-api.min.js"></script>
  <!-- Load FFmpeg.wasm -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.5/dist/ffmpeg.min.js"></script>
  
  <script>
    // Privacy Modal Logic
    const modalOverlay = document.getElementById('modalOverlay');
    const acceptBtn = document.getElementById('acceptBtn');
    const declineBtn = document.getElementById('declineBtn');
    const mainContent = document.getElementById('mainContent');
    
    acceptBtn.addEventListener('click', () => {
      modalOverlay.style.display = 'none';
      mainContent.classList.remove('hidden');
    });
    
    declineBtn.addEventListener('click', () => {
      alert("You must accept the Privacy Policy and Terms of Use to use this website.");
      window.location.href = "https://www.noahabebe.com"; // Replace with your decline page if available.
    });
    
    // Global variable to store recorded video blob
    let recordedBlob = null;
    
    // Upload Form Handling (Modified to convert the recording to MP4)
    const form = document.getElementById('uploadForm');
    const progress = document.getElementById('progress');
    const message = document.getElementById('message');
    const downloadContainer = document.getElementById('downloadContainer');
    const downloadLink = document.getElementById('downloadLink');
    
    form.addEventListener('submit', async function(event) {
      event.preventDefault();
      if (!recordedBlob) {
        alert("Please record a video before submitting.");
        return;
      }
      
      progress.classList.remove('hidden');
      message.classList.add('hidden');
      downloadContainer.classList.add('hidden');

      try {
        // Initialize FFmpeg
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        if (!ffmpeg.isLoaded()) {
          await ffmpeg.load();
        }

        // Write the recorded WebM blob to the FFmpeg file system
        ffmpeg.FS('writeFile', 'input.webm', await fetchFile(recordedBlob));

        // Run FFmpeg command to convert WebM to MP4
        // The command below uses libx264 and AAC for encoding.
        await ffmpeg.run('-i', 'input.webm', '-c:v', 'libx264', '-preset', 'veryfast', '-c:a', 'aac', 'output.mp4');

        // Read the converted MP4 file from the FFmpeg file system
        const data = ffmpeg.FS('readFile', 'output.mp4');
        const mp4Blob = new Blob([data.buffer], { type: 'video/mp4' });

        // Build the form data with the converted MP4 video
        const formData = new FormData();
        formData.append('video', mp4Blob, 'recorded_video.mp4');
        formData.append('script', document.getElementById('script').value);
        formData.append('toggle_face_movement', document.getElementById('toggle_face_movement').checked);
        
        // Upload the form data
        const response = await fetch('/upload', { method: 'POST', body: formData });
        const result = await response.json();
        progress.classList.add('hidden');
        
        if (response.ok) {
          message.textContent = "Video processed successfully!";
          message.classList.remove('hidden', 'bg-red-500');
          message.classList.add('bg-green-500');
          
          downloadLink.href = `/download/${result.video_id}`;
          downloadContainer.classList.remove('hidden');
        } else {
          message.textContent = result.message;
          message.classList.remove('hidden', 'bg-green-500');
          message.classList.add('bg-red-500');
        }
      } catch (error) {
        progress.classList.add('hidden');
        console.error("Error during video conversion/upload:", error);
        message.textContent = "An error occurred. Please try again.";
        message.classList.remove('hidden', 'bg-green-500');
        message.classList.add('bg-red-500');
      }
    });
    
    // Wait for face-api.js to load before calling the initialization function
    window.onload = async function() {
      try {
        await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
        initFaceTracking();  // Call the function after libraries are loaded
      } catch (error) {
        console.error("Error loading face-api models:", error);
      }
    };
    
    // Face Tracking and Video Recording Logic
    function initFaceTracking() {
      const trackingVideo = document.getElementById('trackingVideo');
      const faceGuide = document.getElementById('faceGuide'); // Face guide element
      let stream;
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => {
          stream = s;
          trackingVideo.srcObject = stream;
          trackingVideo.play();
          
          // Setup MediaRecorder for video recording
          const startBtn = document.getElementById('startRecording');
          const stopBtn = document.getElementById('stopRecording');
          let mediaRecorder;
          let recordedChunks = [];
          let recordingTimeout;
          
          startBtn.addEventListener('click', () => {
            recordedChunks = [];
            // Specify WebM format; we will convert it to MP4 later.
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8' });
            mediaRecorder.ondataavailable = function(e) {
              if (e.data.size > 0) {
                recordedChunks.push(e.data);
              }
            };
            mediaRecorder.onstop = function() {
              recordedBlob = new Blob(recordedChunks, { type: 'video/webm' });
              console.log("Recording stopped. Blob size: ", recordedBlob.size);
            };
            mediaRecorder.start();
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            
            // Show face guide when recording starts
            faceGuide.style.opacity = 1;
            
            recordingTimeout = setTimeout(() => { mediaRecorder.stop(); }, 30000);  // Stop recording after 30 seconds
          });
          
          stopBtn.addEventListener('click', () => {
            clearTimeout(recordingTimeout);
            mediaRecorder.stop();
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            
            // Hide face guide when recording stops
            faceGuide.style.opacity = 0;
          });
        })
        .catch(error => console.error("Error accessing webcam:", error));
    }
  </script>
</body>
</html>
